<!DOCTYPE html>
<html lang="ta">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>திருக்குறள் வினாடி வினா - தமிழ் மன்றம்</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Hind+Madurai:wght@400;600&family=Noto+Sans+Tamil:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Hind Madurai", "Noto Sans Tamil", sans-serif;
        background: linear-gradient(135deg, #f9f6e7 0%, #e8f4e8 100%);
        color: #1a3c34;
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      /* Header Styles */
      header {
        background: linear-gradient(to right, #1a3c34, #2a5c4c);
        color: white;
        padding: 15px 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo img {
        height: 50px;
      }

      .logo h1 {
        font-family: "Noto Sans Tamil", sans-serif;
        font-weight: 800;
        font-size: 1.8rem;
      }

      nav ul {
        display: flex;
        list-style: none;
        gap: 25px;
        align-items: center;
      }

      nav a {
        color: white;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: color 0.3s;
        padding: 5px 10px;
        border-radius: 4px;
      }

      nav a:hover {
        color: #ffd700;
        background: rgba(255, 255, 255, 0.1);
      }

      /* Language Switcher */
      .language-switcher {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.15);
        padding: 8px 15px;
        border-radius: 50px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .language-switcher:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      .language-flag {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        background: #f1c40f;
        color: #1a3c34;
      }

      /* Quiz Header */
      .quiz-header {
        background: linear-gradient(to right, #1a3c34, #2a5c4c);
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
      }

      .leafLogo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      .leafLogo h1 {
        font-family: "Noto Sans Tamil", sans-serif;
        font-weight: 800;
        font-size: 1.8rem;
      }

      .quiz-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .quiz-date {
        font-size: 1.1rem;
        color: #ffd700;
      }

      .timer-container {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .timer {
        font-size: 1.2rem;
        font-weight: bold;
      }

      /* Quiz Content */
      .quiz-content {
        padding: 30px;
      }

      .webcam-container {
        margin: 20px 0;
        text-align: center;
        display: none;
      }

      .question-container {
        margin: 30px 0;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        position: relative;
      }

      .question-counter {
        position: absolute;
        top: -15px;
        right: 20px;
        background: #2a5c4c;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .question-text {
        font-size: 1.3rem;
        margin-bottom: 20px;
        color: #1a3c34;
        font-weight: 600;
        text-align: center;
      }

      .answer-input {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        border: 2px solid #2a5c4c;
        border-radius: 8px;
        font-family: "Noto Sans Tamil", sans-serif;
        margin-bottom: 20px;
        text-align: center;
      }

      .controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .submit-container {
        text-align: center;
      }

      .result-container {
        text-align: center;
        padding: 30px;
        background: #f0f7ee;
        border-radius: 10px;
        margin-top: 30px;
      }

      .completion-container {
        text-align: center;
        padding: 40px 30px;
      }

      .completion-icon {
        font-size: 4rem;
        color: #2a5c4c;
        margin-bottom: 20px;
      }

      .completion-message {
        font-size: 1.5rem;
        margin-bottom: 30px;
        color: #1a3c34;
      }

      .completion-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
      }

      /* Buttons */
      .cta-button {
        display: inline-block;
        background: #2a5c4c;
        color: white;
        padding: 12px 30px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(42, 92, 76, 0.3);
        cursor: pointer;
        border: none;
      }

      .cta-button:hover {
        background: #1a3c34;
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(42, 92, 76, 0.4);
      }

      .cta-button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .cta-button.secondary {
        background: #ff6b6b;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .cta-button.secondary:hover {
        background: #e05a5a;
      }

      /* Notification */
      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #ff4d4d;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
        animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Tamil Font Styling */
      .tamil-text {
        font-family: "Noto Sans Tamil", sans-serif;
        font-weight: 600;
      }

      .english-text {
        font-family: "Hind Madurai", sans-serif;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 15px;
        }

        nav ul {
          gap: 15px;
          flex-wrap: wrap;
          justify-content: center;
        }

        .quiz-content {
          padding: 20px;
        }

        .question-text {
          font-size: 1.1rem;
        }

        .cta-button {
          padding: 10px 20px;
          font-size: 1rem;
        }

        .controls-container {
          flex-direction: column;
        }

        .quiz-info {
          flex-direction: column;
          gap: 15px;
        }

        .completion-buttons {
          flex-direction: column;
          align-items: center;
        }
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-content">
        <div class="logo">
          <img
            class="fas fa-leaf tamil-text"
            src="../imgs/jce_logo.png"
            alt="தமிழ் மன்றம் லோகோ"
          />
          <h1
            style="
              font-family: 'Times New Roman', Times, serif;
              font-weight: 800;
              font-size: 24px;
              display: block;
              margin-right: 10px;
              margin: 0;
              color: #fff;
            "
          >
            Jerusalem College of Engineering
          </h1>
        </div>
        <nav>
          <ul>
            <li>
              <a href="../index.html" class="tamil-text" data-key="nav.home"
                >முகப்பு</a
              >
            </li>
            <li>
              <a href="#" class="tamil-text" data-key="nav.events"
                >நிகழ்வுகள்</a
              >
            </li>
            <li>
              <a href="#" class="tamil-text" data-key="nav.kural"
                >திருக்குறள்</a
              >
            </li>
            <li>
              <a href="#" class="tamil-text" data-key="nav.contact"
                >தொடர்புகள்</a
              >
            </li>
            <li>
              <div class="language-switcher" id="languageSwitcher">
                <div class="language-flag">EN</div>
                <span class="tamil-text" data-key="language">தமிழ்</span>
              </div>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <div class="container">
      <!-- Header Section -->
      <div class="quiz-header">
        <div class="leafLogo">
          <i class="fas fa-leaf tamil-text" style="font-size: 2.5rem"></i>
          <h1 class="tamil-text" data-key="quiz.title">
            திருக்குறள் வினாடி வினா
          </h1>
        </div>
        <div class="quiz-info">
          <div class="quiz-date tamil-text" id="quiz-date">
            இன்று: புதன், ஜூலை 12, 2023
          </div>
          <div class="timer-container">
            <i class="fas fa-clock"></i>
            <div class="timer tamil-text" id="timer">20</div>
          </div>
        </div>
      </div>

      <!-- Webcam Verification -->
      <div class="quiz-content" id="webcam-verification">
        <div class="question-container">
          <div class="question-text tamil-text" data-key="webcam.instruction">
            கேமரா அணுகலை சரிபார்க்கவும்
          </div>
          <p class="tamil-text" data-key="webcam.description">
            வினாடி வினாவில் பங்குபெற கேமரா அணுகல் தேவைப்படுகிறது. கீழே உள்ள
            பொத்தானைக் கிளிக் செய்து கேமரா அணுகலை அனுமதிக்கவும்.
          </p>
        </div>

        <div class="submit-container">
          <button
            id="enable-webcam"
            class="cta-button tamil-text"
            data-key="webcam.enable"
          >
            கேமரா அணுகலை அனுமதி
          </button>
        </div>
      </div>

      <!-- Quiz Content -->
      <div class="quiz-content hidden" id="quiz-interface">
        <div class="webcam-container">
          <!-- Webcam will run in background but not displayed -->
          <video id="webcam-video" autoplay playsinline></video>
        </div>

        <div class="question-container">
          <div class="question-counter tamil-text" id="question-counter">
            கேள்வி 1/3
          </div>
          <div
            class="question-text tamil-text"
            id="question-text"
            data-key="load-question"
          >
            கேள்விகளை ஏற்றுகிறது...
          </div>
          <input
            type="text"
            id="answer-input"
            class="answer-input tamil-text"
            data-key="quiz.placeholder"
            placeholder="உங்கள் பதிலை இங்கே 입력வும்"
          />
        </div>

        <div class="controls-container">
          <div></div>
          <div class="submit-container">
            <button
              id="next-question"
              class="cta-button tamil-text"
              disabled
              data-key="quiz.next"
            >
              அடுத்த கேள்வி
            </button>
          </div>
        </div>
      </div>

      <!-- Completion Screen -->
      <div class="quiz-content hidden" id="completion-screen">
        <div class="completion-container">
          <div class="completion-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div
            class="completion-message tamil-text"
            data-key="completion.message"
          >
            வினாடி வினா முடிந்தது!
          </div>
          <div class="completion-buttons">
            <a
              href="../index.html"
              class="cta-button tamil-text"
              data-key="nav.home"
              >முகப்பு</a
            >
            <a
              href="#"
              class="cta-button tamil-text secondary"
              data-key="nav.events"
              >நிகழ்வுகள்</a
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
      <p class="tamil-text">கேமரா அணுகல் தேவைப்படுகிறது!</p>
    </div>

    <script>
      // Google Apps Script URL (Replace with your deployed script URL)
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbzwZoTWMoz5U3lPDsgf88XbLUbBZNkjrRIPDM18qGDa82uMGo9UG4IB3Ubx53G3jpoR/exec";

      // Translation data
      const translations = {
        ta: {
          "nav.home": "முகப்பு",
          "nav.events": "நிகழ்வுகள்",
          "nav.kural": "திருக்குறள்",
          "nav.contact": "தொடர்புகள்",
          language: "தமிழ்",
          "quiz.title": "திருக்குறள் வினாடி வினா",
          "webcam.instruction": "கேமரா அணுகலை சரிபார்க்கவும்",
          "webcam.description":
            "வினாடி வினாவில் பங்குபெற கேமரா அணுகல் தேவைப்படுகிறது. கீழே உள்ள பொத்தானைக் கிளிக் செய்து கேமரா அணுகலை அனுமதிக்கவும்.",
          "webcam.enable": "கேமரா அணுகலை அனுமதி",
          "quiz.placeholder": "உங்கள் பதிலை இங்கே 입력வும்",
          "quiz.next": "அடுத்த கேள்வி",
          "completion.message": "வினாடி வினா முடிந்தது!",
          "load-question": "கேள்விகளை ஏற்றுகிறது...",
        },
        en: {
          "nav.home": "Home",
          "nav.events": "Events",
          "nav.kural": "Thirukural",
          "nav.contact": "Contact",
          language: "English",
          "quiz.title": "Thirukural Quiz",
          "webcam.instruction": "Verify Camera Access",
          "webcam.description":
            "Camera access is required to participate in the quiz. Click the button below to allow camera access.",
          "webcam.enable": "Allow Camera Access",
          "quiz.placeholder": "Type your answer here",
          "quiz.next": "Next Question",
          "completion.message": "Quiz Completed!",
          "load-question": "Loading Questions...",
        },
      };

      // DOM Elements
      const quizDateEl = document.getElementById("quiz-date");
      const questionTextEl = document.getElementById("question-text");
      const answerInputEl = document.getElementById("answer-input");
      const nextQuestionBtn = document.getElementById("next-question");
      const enableWebcamBtn = document.getElementById("enable-webcam");
      const webcamVideoEl = document.getElementById("webcam-video");
      const timerEl = document.getElementById("timer");
      const questionCounterEl = document.getElementById("question-counter");
      const notificationEl = document.getElementById("notification");
      const webcamVerificationEl = document.getElementById(
        "webcam-verification"
      );
      const quizInterfaceEl = document.getElementById("quiz-interface");
      const completionScreenEl = document.getElementById("completion-screen");
      const languageSwitcherEl = document.getElementById("languageSwitcher");

      // Quiz state variables
      let currentQuestions = [];
      let currentQuestionIndex = 0;
      let stream = null;
      let timerInterval = null;
      let timeLeft = 20;
      let currentLanguage = "ta";

      // Set current date
      const today = new Date();
      const options = {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      };
      quizDateEl.textContent = `இன்று: ${today.toLocaleDateString(
        "ta-IN",
        options
      )}`;

      // Initialize translation
      function updateTranslations() {
        document.querySelectorAll("[data-key]").forEach((element) => {
          const key = element.getAttribute("data-key");
          if (translations[currentLanguage][key]) {
            if (element.placeholder) {
              element.placeholder = translations[currentLanguage][key];
            } else {
              element.textContent = translations[currentLanguage][key];
            }
          }
        });

        // Update language switcher
        document.querySelector(".language-flag").textContent =
          currentLanguage === "ta" ? "EN" : "TA";
      }

      // Event listeners
      enableWebcamBtn.addEventListener("click", enableWebcam);
      answerInputEl.addEventListener("input", function () {
        nextQuestionBtn.disabled = !this.value.trim();
      });
      nextQuestionBtn.addEventListener("click", nextQuestion);
      languageSwitcherEl.addEventListener("click", toggleLanguage);

      // Toggle language function
      function toggleLanguage() {
        currentLanguage = currentLanguage === "ta" ? "en" : "ta";
        updateTranslations();
      }

      // Enable webcam function
      function enableWebcam() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({ video: true })
            .then(function (videoStream) {
              stream = videoStream;
              webcamVideoEl.srcObject = stream;

              // Hide verification and show quiz
              webcamVerificationEl.classList.add("hidden");
              quizInterfaceEl.classList.remove("hidden");

              // Start the quiz
              initQuiz();
            })
            .catch(function (error) {
              showNotification("கேமரா அணுகல் மறுக்கப்பட்டது!");
              console.error("Camera error: ", error);
            });
        } else {
          showNotification("கேமரா ஆதரவு இல்லை!");
        }
      }

      // Initialize quiz function using JSONP to avoid CORS issues
      function initQuiz() {
        // Use JSONP approach
        const script = document.createElement("script");
        script.src = `${scriptURL}?callback=handleQuestions&r=${new Date().getTime()}`;

        // Add error handling
        script.onerror = function () {
          console.error("Failed to load questions from Google Script");
          handleQuestions([]);
        };

        // Set timeout for JSONP request
        const timeout = setTimeout(function () {
          document.body.removeChild(script);
          console.error("JSONP request timed out");
          handleQuestions([]);
        }, 5000);

        // Handle successful load

        window.handleQuestions = function (data) {
          clearTimeout(timeout);
          document.body.removeChild(script);
          delete window.handleQuestions;

          console.log("Received from Google Apps Script:", data);

          // Use fetched questions or show error if empty
          if (!data || data.length === 0) {
            showNotification(
              "கேள்விகள் ஏற்றப்படவில்லை! தயவு செய்து பின்னர் முயற்சிக்கவும்."
            );
            return;
          }

          currentQuestions = data;
          currentQuestionIndex = 0;
          answerInputEl.value = "";
          nextQuestionBtn.disabled = true;

          // Display the first question
          displayQuestion(currentQuestions[currentQuestionIndex]);
        };

        document.body.appendChild(script);
      }

      // Display question function with error handling
      function displayQuestion(question) {
        // Check if question is valid
        if (!question || !question.text) {
          console.error("Invalid question:", question);
          showNotification("தவறான கேள்வி வடிவம்!");

          // Try to move to next question or show completion
          if (currentQuestionIndex + 1 < currentQuestions.length) {
            currentQuestionIndex++;
            displayQuestion(currentQuestions[currentQuestionIndex]);
          } else {
            showCompletionScreen();
          }
          return;
        }

        // Update question text and counter
        questionTextEl.textContent = question.text;
        questionCounterEl.textContent = `கேள்வி ${currentQuestionIndex + 1}/${
          currentQuestions.length
        }`;

        // Clear input field
        answerInputEl.value = "";
        nextQuestionBtn.disabled = true;

        // Focus on input field
        setTimeout(() => answerInputEl.focus(), 100);

        // Start timer
        startTimer();
      }

      // Next question function - FIXED
      async function nextQuestion() {
        const userAnswer = answerInputEl.value.trim();
        const currentQuestion = currentQuestions[currentQuestionIndex];

        // Validate answer
        if (!userAnswer) {
          showNotification("நேரம் முடிந்தது!");
          return;
        }
        saveResponseToSheets(currentQuestion, userAnswer);

        // Save response to Google Sheets
        // try {
        //   await saveResponseToSheets({
        //     questionId: currentQuestion.id,
        //     questionText: currentQuestion.text,
        //     userAnswer: userAnswer,
        //     timestamp: new Date().toISOString(),
        //     // pattern: `Pattern ${currentQuestionIndex + 1}`, // Add pattern information
        //   });
        // } catch (error) {
        //   console.error("Error saving response:", error);
        // }
        // Save response
        function saveResponseToSheets(q, answer) {
          fetch(scriptURL, {
            method: "POST",
            body: JSON.stringify({
              questionId: q.id,
              questionText: q.text,
              userAnswer: answer,
              timestamp: new Date().toISOString(),
            }),
          })
            .then((res) => res.json())
            .then((res) => console.log("Saved:", res))
            .catch((err) => console.error("Error saving response:", err));
        }
        // Stop timer
        clearInterval(timerInterval);

        // Move to next question or show completion screen
        currentQuestionIndex++;

        if (currentQuestionIndex < currentQuestions.length) {
          displayQuestion(currentQuestions[currentQuestionIndex]);
        } else {
          showCompletionScreen();
        }
      }

      // Save response to Google Sheets
      //   async function saveResponseToSheets(responseData) {
      //     try {
      //       const response = await fetch(scriptURL, {
      //         method: "POST",
      //         headers: {
      //           "Content-Type": "application/json",
      //         },
      //         body: JSON.stringify(responseData),
      //       });

      //       if (!response.ok) {
      //         throw new Error(`HTTP error! status: ${response.status}`);
      //       }

      //       const result = await response.json();
      //       console.log("Save response result:", result);
      //     } catch (error) {
      //       console.error("Error saving to Google Sheets:", error);
      //       // Don't throw error here - we don't want to break the quiz flow
      //     }
      //   }

      // Show completion screen
      function showCompletionScreen() {
        quizInterfaceEl.classList.add("hidden");
        completionScreenEl.classList.remove("hidden");

        // Stop webcam
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
      }

      // Timer function
      function startTimer() {
        timeLeft = 20;
        timerEl.textContent = timeLeft;

        clearInterval(timerInterval);

        timerInterval = setInterval(() => {
          timeLeft--;
          timerEl.textContent = timeLeft;

          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            nextQuestion();
          }
        }, 1000);
      }

      // Show notification function
      function showNotification(message) {
        notificationEl.querySelector("p").textContent = message;
        notificationEl.style.display = "block";

        setTimeout(() => {
          notificationEl.style.display = "none";
        }, 3000);
      }

      // Initialize translations
      updateTranslations();
      initQuiz();
    </script>
  </body>
</html>
