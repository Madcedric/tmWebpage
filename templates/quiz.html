<!DOCTYPE html>
<html lang="ta">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>திருக்குறள் வினாடி வினா - தமிழ் மன்றம்</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Hind+Madurai:wght@400;600&family=Noto+Sans+Tamil:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../CSS/quiz.css" />
    <style></style>
  </head>
  <body>
    <header>
      <div class="header-content">
        <div class="logo">
          <img
            class="fas fa-leaf tamil-text"
            src="../imgs/jce_logo.png"
            alt="தமிழ் மன்றம் லோகோ"
          />
          <h1
            class="tamil-text"
            style="
              font-family: 'Times New Roman', Times, serif;
              font-weight: 800;
              font-size: 24px;
              display: block;
              margin-right: 10px;
              margin: 0;
              color: #fff;
            "
          >
            Jerusalem College of Engineering
          </h1>
        </div>
        <nav>
          <ul>
            <li>
              <a href="../index.html" class="tamil-text" data-key="nav.home"
                >முகப்பு</a
              >
            </li>
            <li>
              <a href="#" class="tamil-text" data-key="nav.events"
                >நிகழ்வுகள்</a
              >
            </li>
            <li>
              <a href="#" class="tamil-text" data-key="nav.kural"
                >திருக்குறள்</a
              >
            </li>
            <li>
              <a href="#" class="tamil-text" data-key="nav.contact"
                >தொடர்புகள்</a
              >
            </li>
            <li>
              <div class="language-switcher" id="languageSwitcher">
                <div class="language-flag">EN</div>
                <span class="tamil-text" data-key="language">தமிழ்</span>
              </div>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <div class="container">
      <!-- Header Section -->
      <div class="quiz-header">
        <div class="leafLogo">
          <i class="fas fa-leaf tamil-text" style="font-size: 2.5rem"></i>
          <h1 class="tamil-text" data-key="quiz.title">
            திருக்குறள் வினாடி வினா
          </h1>
        </div>
        <div class="quiz-info">
          <div class="quiz-date tamil-text" id="quiz-date">
            இன்று: புதன், ஜூலை 12, 2023
          </div>
          <div class="timer-container">
            <i class="fas fa-clock"></i>
            <div class="timer tamil-text" id="timer">20</div>
          </div>
        </div>
      </div>

      <!-- Webcam Verification -->
      <div class="quiz-content" id="webcam-verification">
        <div class="question-container">
          <div class="question-text tamil-text" data-key="webcam.instruction">
            கேமரா அணுகலை சரிபார்க்கவும்
          </div>
          <p class="tamil-text" data-key="webcam.description">
            வினாடி வினாவில் பங்குபெற கேமரா அணுகல் தேவைப்படுகிறது. கீழே உள்ள
            பொத்தானைக் கிளிக் செய்து கேமரா அணுகலை அனுமதிக்கவும்.
          </p>
        </div>

        <div class="submit-container">
          <button
            id="enable-webcam"
            class="cta-button tamil-text"
            data-key="webcam.enable"
          >
            கேமரா அணுகலை அனுமதி
          </button>
        </div>
      </div>

      <!-- Quiz Content -->
      <div class="quiz-content hidden" id="quiz-interface">
        <div class="webcam-container">
          <!-- Webcam will run in background but not displayed -->
          <video id="webcam-video" autoplay playsinline></video>
        </div>

        <div class="question-container">
          <div class="question-counter tamil-text" id="question-counter">
            கேள்வி 1/3
          </div>
          <div class="question-text tamil-text" id="question-text">
            எந்த திருக்குறள் 'அகர' என்று தொடங்குகிறது?
          </div>
          <input
            type="text"
            id="answer-input"
            class="answer-input tamil-text"
            data-key="quiz.placeholder"
            placeholder="உங்கள் பதிலை இங்கே 입력வும்"
          />
        </div>

        <div class="controls-container">
          <div></div>
          <!-- Empty div for spacing -->
          <div class="submit-container">
            <button
              id="next-question"
              class="cta-button tamil-text"
              disabled
              data-key="quiz.next"
            >
              அடுத்த கேள்வி
            </button>
          </div>
        </div>
      </div>

      <!-- Completion Screen -->
      <div class="quiz-content hidden" id="completion-screen">
        <div class="completion-container">
          <div class="completion-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div
            class="completion-message tamil-text"
            data-key="completion.message"
          >
            வினாடி வினா முடிந்தது!
          </div>
          <div class="completion-buttons">
            <a
              href="index.html"
              class="cta-button tamil-text"
              data-key="nav.home"
              >முகப்பு</a
            >
            <a
              href="#"
              class="cta-button tamil-text secondary"
              data-key="nav.events"
              >நிகழ்வுகள்</a
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
      <p class="tamil-text">கேமரா அணுகல் தேவைப்படுகிறது!</p>
    </div>

    <script>
      // Google Apps Script URL (Replace with your deployed script URL)
      const scriptURL =
        "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

      // Translation data
      const translations = {
        ta: {
          "nav.home": "முகப்பு",
          "nav.events": "நிகழ்வுகள்",
          "nav.kural": "திருக்குறள்",
          "nav.contact": "தொடர்புகள்",
          language: "தமிழ்",
          "quiz.title": "திருக்குறள் வினாடி வினா",
          "webcam.instruction": "கேமரா அணுகலை சரிபார்க்கவும்",
          "webcam.description":
            "வினாடி வினாவில் பங்குபெற கேமரா அணுகல் தேவைப்படுகிறது. கீழே உள்ள பொத்தானைக் கிளிக் செய்து கேமரா அணுகலை அனுமதிக்கவும்.",
          "webcam.enable": "கேமரா அணுகலை அனுமதி",
          "quiz.placeholder": "உங்கள் பதிலை இங்கே 입력வும்",
          "quiz.next": "அடுத்த கேள்வி",
          "completion.message": "வினாடி வினா முடிந்தது!",
        },
        en: {
          "nav.home": "Home",
          "nav.events": "Events",
          "nav.kural": "Thirukural",
          "nav.contact": "Contact",
          language: "English",
          "quiz.title": "Thirukural Quiz",
          "webcam.instruction": "Verify Camera Access",
          "webcam.description":
            "Camera access is required to participate in the quiz. Click the button below to allow camera access.",
          "webcam.enable": "Allow Camera Access",
          "quiz.placeholder": "Type your answer here",
          "quiz.next": "Next Question",
          "completion.message": "Quiz Completed!",
        },
      };

      // DOM Elements
      const quizDateEl = document.getElementById("quiz-date");
      const questionTextEl = document.getElementById("question-text");
      const answerInputEl = document.getElementById("answer-input");
      const nextQuestionBtn = document.getElementById("next-question");
      const enableWebcamBtn = document.getElementById("enable-webcam");
      const webcamVideoEl = document.getElementById("webcam-video");
      const timerEl = document.getElementById("timer");
      const questionCounterEl = document.getElementById("question-counter");
      const notificationEl = document.getElementById("notification");
      const webcamVerificationEl = document.getElementById(
        "webcam-verification"
      );
      const quizInterfaceEl = document.getElementById("quiz-interface");
      const completionScreenEl = document.getElementById("completion-screen");
      const languageSwitcherEl = document.getElementById("languageSwitcher");

      // Quiz state variables
      let currentQuestions = [];
      let currentQuestionIndex = 0;
      let stream = null;
      let timerInterval = null;
      let timeLeft = 20;
      let currentLanguage = "ta";

      // Set current date
      const today = new Date();
      const options = {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      };
      quizDateEl.textContent = `இன்று: ${today.toLocaleDateString(
        "ta-IN",
        options
      )}`;

      // Initialize translation
      function updateTranslations() {
        document.querySelectorAll("[data-key]").forEach((element) => {
          const key = element.getAttribute("data-key");
          if (translations[currentLanguage][key]) {
            if (element.placeholder) {
              element.placeholder = translations[currentLanguage][key];
            } else {
              element.textContent = translations[currentLanguage][key];
            }
          }
        });

        // Update language switcher
        document.querySelector(".language-flag").textContent =
          currentLanguage === "ta" ? "EN" : "TA";
      }

      // Event listeners
      enableWebcamBtn.addEventListener("click", enableWebcam);
      answerInputEl.addEventListener("input", function () {
        nextQuestionBtn.disabled = !this.value.trim();
      });
      nextQuestionBtn.addEventListener("click", nextQuestion);
      languageSwitcherEl.addEventListener("click", toggleLanguage);

      // Toggle language function
      function toggleLanguage() {
        currentLanguage = currentLanguage === "ta" ? "en" : "ta";
        updateTranslations();
      }

      // Enable webcam function
      function enableWebcam() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({ video: true })
            .then(function (videoStream) {
              stream = videoStream;
              webcamVideoEl.srcObject = stream;

              // Hide verification and show quiz
              webcamVerificationEl.classList.add("hidden");
              quizInterfaceEl.classList.remove("hidden");

              // Start the quiz
              initQuiz();
            })
            .catch(function (error) {
              showNotification("கேமரா அணுகல் மறுக்கப்பட்டது!");
              console.error("Camera error: ", error);
            });
        } else {
          showNotification("கேமரா ஆதரவு இல்லை!");
        }
      }

      // Initialize quiz function
      async function initQuiz() {
        try {
          // Fetch questions from Google Apps Script
          const response = await fetch(scriptURL);
          const questionsData = await response.json();

          currentQuestions = questionsData;
          currentQuestionIndex = 0;
          answerInputEl.value = "";
          nextQuestionBtn.disabled = true;

          // Display the first question
          displayQuestion(currentQuestions[currentQuestionIndex]);
        } catch (error) {
          console.error("Error loading questions:", error);
          currentLanguage === "ta"
            ? showNotification("கேள்விகள் ஏற்றப்படுவதில் பிழை!")
            : showNotification("Error loading questions");

          //   showNotification("கேள்விகள் ஏற்றப்படுவதில் பிழை!");

          // Fallback to local questions if server fails
          setTimeout(() => {
            // This would be your fallback questions
            // For now, we'll just show completion screen
            showCompletionScreen();
          }, 2000);
        }
      }

      // Display question function
      function displayQuestion(question) {
        // Update question text and counter
        questionTextEl.textContent = question.text;
        questionCounterEl.textContent = `கேள்வி ${currentQuestionIndex + 1}/${
          currentQuestions.length
        }`;

        // Clear input field
        answerInputEl.value = "";
        nextQuestionBtn.disabled = true;

        // Focus on input field
        setTimeout(() => answerInputEl.focus(), 100);

        // Start timer
        startTimer();
      }

      // Next question function
      async function nextQuestion() {
        const userAnswer = answerInputEl.value.trim();
        const currentQuestion = currentQuestions[currentQuestionIndex];

        // Save response to Google Sheets
        try {
          await saveResponseToSheets({
            questionId: currentQuestion.id,
            questionText: currentQuestion.text,
            userAnswer: userAnswer,
            timestamp: new Date().toISOString(),
          });
        } catch (error) {
          console.error("Error saving response:", error);
        }

        // Stop timer
        clearInterval(timerInterval);

        // Move to next question or show completion screen
        currentQuestionIndex++;

        if (currentQuestionIndex < currentQuestions.length) {
          displayQuestion(currentQuestions[currentQuestionIndex]);
        } else {
          showCompletionScreen();
        }
      }

      // Save response to Google Sheets
      async function saveResponseToSheets(responseData) {
        try {
          await fetch(scriptURL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(responseData),
          });
        } catch (error) {
          console.error("Error saving to Google Sheets:", error);
          throw error;
        }
      }

      // Show completion screen
      function showCompletionScreen() {
        quizInterfaceEl.classList.add("hidden");
        completionScreenEl.classList.remove("hidden");

        // Stop webcam
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
      }

      // Timer function
      function startTimer() {
        timeLeft = 20;
        timerEl.textContent = timeLeft;

        clearInterval(timerInterval);

        timerInterval = setInterval(() => {
          timeLeft--;
          timerEl.textContent = timeLeft;

          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            nextQuestion();
          }
        }, 1000);
      }

      // Show notification function
      function showNotification(message) {
        notificationEl.querySelector("p").textContent = message;
        notificationEl.style.display = "block";

        setTimeout(() => {
          notificationEl.style.display = "none";
        }, 3000);
      }

      // Initialize translations
      updateTranslations();
    </script>
  </body>
</html>
